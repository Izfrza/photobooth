<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photobooth Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Gunakan min-height agar konten tetap terlihat jika lebih panjang dari viewport */
            background: url('https://source.unsplash.com/random/1920x1080') no-repeat center center/cover;
            color: rgb(16, 16, 16);
            padding: 20px 0; /* Tambahkan padding untuk scroll jika konten banyak */
        }

        .container {
            background: rgba(255, 255, 255, 0.25); /* Sedikit lebih tebal agar terbaca */
            padding: 20px; /* Tambah padding container */
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
            width: 90%; /* Batasi lebar container */
            max-width: 1000px; /* Maksimum lebar */
        }

        .container h1 {
            color: #242424; /* Ubah warna judul agar kontras dengan background semi-transparan */
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        video {
            width: 100%; /* Buat video responsif */
            max-width: 480px; /* Batasi lebar maksimum video */
            height: auto;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5); /* Perjelas shadow video */
            display: block;
            margin: 0 auto 15px auto; /* Pusatkan video dan beri margin bawah */
        }

        .timer {
            position: absolute;
            top: 70px; /* Sesuaikan posisi timer */
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px; /* Perbesar font timer */
            font-weight: bold;
            color: #303030;
            background-color: rgba(0,0,0,0.5); /* Background agar lebih terbaca */
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 10;
        }

        .photo-strip {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            margin: 20px auto; /* Pusatkan photo-strip */
            border-radius: 10px;
            background: white;
            width: 150px; /* Perbesar sedikit */
            min-height: 330px; /* Sesuaikan tinggi agar 3 foto pas */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            overflow-y: auto; /* Jika ada lebih banyak foto, bisa di-scroll */
        }

        .photo-strip img {
            width: 90%; /* Beri sedikit padding di dalam strip */
            height: auto;
            border-radius: 5px; /* Perhalus border radius gambar */
            margin-bottom: 10px;
            border: 1px solid #eee; /* Tambahkan border tipis */
        }
        
        /* CSS untuk QR Code Container */
        #qrcodeContainer {
            background-color: rgba(255, 255, 255, 0.9);
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            color: #333;
            text-align: center;
        }
        #qrcodeCanvas {
            margin: 10px auto;
            display: flex; /* Untuk memusatkan canvas jika library membuat elemen lain */
            justify-content: center;
        }
        #qrcodeCanvas img { /* Jika qrcode.js membuat img di dalam canvas div */
            margin: auto;
        }

    </style>
</head>

<body>
    <div class="container text-center">
        <h1>Photobooth Web</h1>
        <div class="row">
            <div class="col-md-6 position-relative mb-3">
                <div class="timer" id="timer"></div>
                <video id="video" autoplay playsinline></video> <div class="mt-2">
                    <label for="timerValue" class="form-label" style="color: #181818;">Detik Timer:</label>
                    <input type="number" id="timerValue" min="1" max="10" value="3" class="form-control w-50 mx-auto mb-2">
                    <button class="btn btn-danger mt-1" id="capture">‚è≥ Mulai Foto</button>
                    <button class="btn btn-warning mt-1 d-none" id="clear">üîÑ Refresh</button>
                    <button class="btn btn-success mt-1 d-none" id="download">‚¨áÔ∏è Download & QR</button>
                </div>
                <div class="mt-3">
                    <label for="filter" class="form-label" style="color: #121212;">Filter:</label>
                    <select id="filter" class="form-select">
                        <option value="none">Tanpa Filter</option>
                        <option value="grayscale(100%)">Grayscale</option>
                        <option value="sepia(100%)">Sepia</option>
                        <option value="invert(100%)">Invert</option>
                        <option value="blur(3px)">Blur</option>
                        <option value="contrast(200%)">Kontras Tinggi</option>
                        <option value="brightness(150%)">Lebih Cerah</option>
                        <option value="saturate(200%)">Saturasi Tinggi</option>
                        <option value="hue-rotate(90deg)">Warna Unik</option>
                    </select>
                </div>
                <div class="mt-2">
                    <label for="frame" class="form-label" style="color: #1d1d1d;">Bingkai (Pre-Capture - Contoh):</label>
                     <select id="frame" class="form-select">
                        <option value="none">Tanpa Bingkai</option>
                        <option value="https://i.ibb.co/2qXGJ8h/frame1.png">Bingkai Merah</option>
                        <option value="https://i.ibb.co/hgZtkDn/frame2.png">Bingkai Bunga</option>
                        <option value="https://i.ibb.co/PCX1M0r/frame3.png">Bingkai Gold</option>
                    </select>
                </div>
            </div>
            <div class="col-md-6 d-flex flex-column align-items-center">
                <div class="photo-strip" id="photoStrip">
                    </div>
                 <div id="qrcodeContainer" class="mt-3" style="display: none;">
                    <p>Pindai QR Code ini untuk mengunduh ke HP:</p>
                    <div id="qrcodeCanvas"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const video = document.getElementById('video');
        const captureBtn = document.getElementById('capture');
        const downloadBtn = document.getElementById('download');
        const clearBtn = document.getElementById('clear');
        const filterSelect = document.getElementById('filter');
        const timerInput = document.getElementById('timerValue');
        const photoStrip = document.getElementById('photoStrip');
        const timerDisplay = document.getElementById('timer');
        const frameSelect = document.getElementById('frame'); // Definisikan frameSelect di sini

        let photos = [];
        let selectedFrame = 'none'; // Deklarasikan selectedFrame sebelum digunakan

        // Inisialisasi Video
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    video.srcObject = stream;
                    video.play(); // Pastikan video dimainkan
                })
                .catch(err => {
                    console.error("Error accessing webcam: ", err);
                    alert("Tidak bisa mengakses webcam. Pastikan Anda memberikan izin.");
                });
        } else {
            alert("getUserMedia tidak didukung di browser ini.");
        }


        filterSelect.addEventListener('change', () => {
            video.style.filter = filterSelect.value;
        });

        frameSelect.addEventListener('change', () => { // Event listener untuk frame select
            selectedFrame = frameSelect.value;
            // Logika untuk menerapkan frame pre-capture ke video feed bisa ditambahkan di sini jika diinginkan
            // Contoh: membuat overlay di atas video, atau jika frame adalah CSS filter
            console.log("Selected frame (pre-capture):", selectedFrame);
        });


        captureBtn.addEventListener('click', async () => {
            captureBtn.disabled = true;
            timerInput.disabled = true;
            filterSelect.disabled = true;
            frameSelect.disabled = true;
            document.getElementById('qrcodeContainer').style.display = 'none'; // Sembunyikan QR jika ada
            photoStrip.innerHTML = ''; // Bersihkan strip foto lama
            photos = [];


            for (let i = 0; i < 3; i++) {
                let countdown = parseInt(timerInput.value) || 3;
                for (let j = countdown; j > 0; j--) {
                    timerDisplay.innerText = j;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                timerDisplay.innerText = 'üì∏'; // Smile!
                await new Promise(resolve => setTimeout(resolve, 300)); // Sedikit jeda sebelum capture
                timerDisplay.innerText = '';
                takePhoto();
                if (i < 2) { // Jangan tunggu setelah foto terakhir
                    await new Promise(resolve => setTimeout(resolve, 700)); // Jeda antar foto
                }
            }

            captureBtn.disabled = false;
            timerInput.disabled = false;
            filterSelect.disabled = false;
            frameSelect.disabled = false;

            if (photos.length === 3) {
                downloadBtn.classList.remove('d-none');
                clearBtn.classList.remove('d-none');
            }
        });

        function takePhoto() {
            if (photos.length >= 3) return; // Batasi 3 foto

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Sesuaikan ukuran canvas dengan aspek rasio video
            const aspectRatio = video.videoWidth / video.videoHeight;
            canvas.width = video.videoWidth > 480 ? 480 : video.videoWidth; // Batasi lebar capture
            canvas.height = canvas.width / aspectRatio;

            // Terapkan filter dari video ke canvas
            ctx.filter = getComputedStyle(video).filter;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Jika ada frame terpilih (contoh: frame sebagai overlay pada setiap foto)
            // Ini adalah contoh sederhana, mungkin perlu penyesuaian lebih lanjut
            if (selectedFrame !== 'none' && frameSelect.value !== 'none') { // Cek lagi frameSelect.value karena selectedFrame bisa saja dari sesi lalu
                const frameImg = new Image();
                frameImg.crossOrigin = "anonymous"; // Jika frame dari domain lain
                frameImg.onload = () => {
                    ctx.drawImage(frameImg, 0, 0, canvas.width, canvas.height);
                    addPhotoToStrip(canvas.toDataURL('image/png'));
                }
                frameImg.onerror = () => { // Jika frame gagal dimuat, tetap tambahkan foto
                    console.error("Gagal memuat gambar frame:", frameSelect.value);
                    addPhotoToStrip(canvas.toDataURL('image/png'));
                }
                frameImg.src = frameSelect.value; // Ambil value langsung dari select untuk frame terbaru
            } else {
                addPhotoToStrip(canvas.toDataURL('image/png'));
            }
        }

        function addPhotoToStrip(imageDataUrl) {
            const img = document.createElement('img');
            img.src = imageDataUrl;
            photoStrip.appendChild(img);
            photos.push(img); // Simpan elemen img atau dataURL, konsisten
        }


        downloadBtn.addEventListener('click', () => {
            if (photos.length < 3) {
                alert("Silakan ambil 3 foto terlebih dahulu.");
                return;
            }

            // Opsi untuk html2canvas
            const options = {
                backgroundColor: '#FFFFFF', // Atur background putih untuk strip
                scale: 2, // Tingkatkan skala untuk kualitas lebih baik
                useCORS: true, // Jika gambar di strip berasal dari domain lain (misal frame)
                logging: true,
                onclone: (documentClone) => { // Memastikan semua gambar sudah dimuat sebelum render
                    const stripImages = documentClone.querySelectorAll('#photoStrip img');
                    const promises = [];
                    stripImages.forEach(img => {
                        if (!img.complete) {
                            promises.push(new Promise((resolve, reject) => {
                                img.onload = resolve;
                                img.onerror = reject;
                            }));
                        }
                    });
                    return Promise.all(promises);
                }
            };


            html2canvas(photoStrip, options).then(canvas => {
                const imageDataUrl = canvas.toDataURL('image/png');

                // 1. Trigger download lokal
                const link = document.createElement('a');
                link.href = imageDataUrl;
                link.download = 'photobooth_strip.png';
                link.click();

                // 2. Upload untuk QR Code
                uploadImageForQr(imageDataUrl);

            }).catch(err => {
                console.error("Error saat html2canvas:", err);
                alert("Gagal membuat gambar strip. Coba lagi.");
            });
        });

        clearBtn.addEventListener('click', () => {
            photoStrip.innerHTML = '';
            photos = [];
            clearBtn.classList.add('d-none');
            downloadBtn.classList.add('d-none');
            document.getElementById('qrcodeContainer').style.display = 'none'; // Sembunyikan QR
            timerDisplay.innerText = ''; // Bersihkan juga timer display
        });


        // Fungsi untuk upload dan QR Code (sudah Anda buat, sedikit penyesuaian)
        async function uploadImageForQr(dataUrl) {
            console.log("Mengunggah gambar untuk QR Code...");
            try {
                const response = await fetch('upload.php', { // Pastikan path ke skrip PHP benar
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: 'imageData=' + encodeURIComponent(dataUrl)
                });

                if (!response.ok) {
                    // Coba dapatkan detail error dari server jika ada
                    let errorText = response.statusText;
                    try {
                        const errorBody = await response.text(); // atau response.json() jika server mengirim JSON error
                        errorText += ` - ${errorBody}`;
                    } catch (e) { /* abaikan jika body tidak bisa dibaca */ }
                    throw new Error('Network response was not ok: ' + errorText);
                }

                const result = await response.json();

                if (result.success && result.imageUrl) {
                    console.log("Upload berhasil, URL Gambar:", result.imageUrl);
                    generateAndShowQrCode(result.imageUrl);
                } else {
                    console.error('Upload failed server-side:', result.message || 'Unknown error from server');
                    alert('Gagal membuat QR Code (server): ' + (result.message || 'Silakan coba lagi.'));
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Terjadi kesalahan teknis saat mengunggah gambar untuk QR Code. ' + error.message);
            }
        }

        function generateAndShowQrCode(imageUrl) {
            const qrcodeContainer = document.getElementById('qrcodeContainer');
            const qrcodeCanvasDiv = document.getElementById('qrcodeCanvas'); // Ini adalah DIV
            
            qrcodeCanvasDiv.innerHTML = ''; // Bersihkan QR code sebelumnya jika ada

            try {
                new QRCode(qrcodeCanvasDiv, { // Targetkan DIV, bukan canvas langsung jika library yg handle
                    text: imageUrl,
                    width: 128,
                    height: 128,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });
                qrcodeContainer.style.display = 'block';
                console.log("QR Code berhasil dibuat untuk URL:", imageUrl);
            } catch(e) {
                console.error("Error membuat QR Code dengan library:", e);
                alert("Gagal menampilkan QR Code.");
            }
        }

        // Logika untuk frame pre-capture yang lebih kompleks (misalnya overlay di atas video)
        // akan memerlukan penyesuaian lebih lanjut dan mungkin elemen canvas tambahan.
        // Bagian `photoContainer` yang sebelumnya ada, jika tujuannya untuk frame pada setiap foto
        // setelah diambil, juga perlu direvisi implementasinya.
        // Fokus saat ini adalah fungsionalitas dasar dan QR code.
    </script>
</body>

</html>
